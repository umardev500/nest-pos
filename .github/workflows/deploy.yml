name: Deploy NestJS App to VPS

on:
  push:
    branches:
      - main  # Trigger deployment on push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa  # Add your VPS SSH key to authenticate
        chmod 600 ~/.ssh/id_rsa  # Ensure proper permissions
        ssh-keyscan ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts  # Avoid SSH prompt for unverified host

    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_IP }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          export PATH=$PATH:/usr/local/bin:/root/.nvm/versions/node/v22.14.0/bin

          yarn -v
          pm2 -v

          cd ~/app/nest-pos
          git pull origin main

          yarn install --production

          rm -f .env
          cp .env.example .env

          make migrate
          yarn build
          pm2 restart my-nest-app

          # ✅ Generate Git commit history JSON
          node -e "
            const fs = require('fs');
            const { execSync } = require('child_process');
            const log = execSync('git log --pretty=format:\\'%h|%an|%ad|%s\\' --date=short').toString();
            const commits = log.split('\\n').map(l => {
              const [hash, author, date, message] = l.split('|');
              return { hash, author, date, message };
            });
            fs.writeFileSync('commits.json', JSON.stringify(commits, null, 2));
          "

          # ✅ Copy to web-accessible directory
          cp commits.json /var/www/html/apks/commits.json

